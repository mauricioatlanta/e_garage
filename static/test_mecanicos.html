<!DOCTYPE html>
<html>
<head>
    <title>Test Crear Mec√°nico</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Test Crear Mec√°nico - E-Garage</h1>
    
    <div id="test-results">
        <h2>Resultados del Test:</h2>
        <div id="output"></div>
    </div>
    
    <hr>
    
    <h2>Test Manual:</h2>
    <input type="text" id="nombreMecanico" placeholder="Nombre del mec√°nico" value="Test Mec√°nico Manual">
    <button onclick="testCrearMecanico()">Crear Mec√°nico</button>
    
    <script>
        function log(message) {
            $('#output').append('<p>' + message + '</p>');
            console.log(message);
        }
        
        function testCrearMecanico() {
            const nombre = $('#nombreMecanico').val();
            
            log('üß™ Iniciando test de creaci√≥n de mec√°nico: ' + nombre);
            
            // Obtener CSRF token de la cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken');
            log('üîë CSRF Token: ' + (csrftoken ? csrftoken.substring(0, 10) + '...' : 'NO ENCONTRADO'));
            
            // Realizar petici√≥n AJAX
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            
            $.post('/documentos/api/crear_mecanico/', {
                'nombre': nombre,
                'csrfmiddlewaretoken': csrftoken
            })
            .done(function(data) {
                log('‚úÖ √âxito: ' + JSON.stringify(data));
                log('üìä Mec√°nico creado - ID: ' + data.id + ', Nombre: ' + data.nombre);
            })
            .fail(function(xhr, status, error) {
                log('‚ùå Error: ' + status + ' - ' + error);
                log('üìÑ Response: ' + xhr.responseText);
                log('üìä Status Code: ' + xhr.status);
            });
        }
        
        // Auto-ejecutar test al cargar
        $(document).ready(function() {
            log('üöÄ P√°gina cargada, iniciando tests autom√°ticos...');
            
            // Test 1: Verificar que jQuery funciona
            log('‚úÖ jQuery cargado: ' + $.fn.jquery);
            
            // Test 2: Verificar CSRF token
            const csrftoken = function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }('csrftoken');
            
            if (csrftoken) {
                log('‚úÖ CSRF Token disponible');
            } else {
                log('‚ùå CSRF Token no encontrado - redirecting...');
                // Redirigir para obtener token
                window.location.href = '/documentos/nuevo/';
                return;
            }
            
            // Test 3: Crear mec√°nico autom√°tico
            setTimeout(function() {
                $('#nombreMecanico').val('Test Autom√°tico ' + new Date().getTime());
                testCrearMecanico();
            }, 1000);
        });
    </script>
</body>
</html>
